<% layout("../layouts/boilerplate.ejs") -%>

<style>
/* ========== PAGE LAYOUT ========== */
.listing-page {
  background: #f7f7f7;
  padding: 50px 20px;
  display: flex;
  justify-content: center;
}

.listing-card {
  background: #fff;
  max-width: 900px;
  width: 100%;
  border-radius: 18px;
  overflow: hidden;
  box-shadow: 0 14px 40px rgba(0,0,0,0.08);
}

/* ========== IMAGE ========== */
.listing-image img {
  width: 100%;
  height: 420px;
  object-fit: cover;
}

/* ========== CONTENT ========== */
.listing-content {
  padding: 40px;
}

.listing-title {
  font-size: 30px;
  font-weight: 600;
  margin-bottom: 8px;
}

.listing-location {
  color: #777;
  margin-bottom: 18px;
}

.listing-owner {
  font-size: 14px;
  color: #555;
  margin-bottom: 22px;
}

.listing-description {
  font-size: 16px;
  line-height: 1.6;
  color: #333;
  margin-bottom: 30px;
}

/* ========== PRICE + ACTIONS ========== */
.listing-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 20px;
  border-top: 1px solid #eee;
}

.listing-price {
  font-size: 22px;
  font-weight: 600;
}

.actions {
  display: flex;
  gap: 12px;
}

/* ========== BUTTONS ========== */
.btn {
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
}

.btn-edit {
  background: #222;
  color: #fff;
}

.btn-delete {
  background: #ff385c;
  color: #fff;
}

/* ========== REVIEW FORM ========== */
.review-box {
  padding: 35px 40px;
  border-top: 1px solid #eee;
  background: #fafafa;
}

.review-box h4 {
  margin-bottom: 20px;
  font-weight: 600;
}

fieldset.starability-slot {
  margin-bottom: 20px;
}

/* ========== REVIEWS ========== */
.reviews-section {
  padding: 35px 40px;
  border-top: 1px solid #eee;
}

.reviews-title {
  margin-bottom: 25px;
  font-weight: 600;
}

.review-card {
  background: #fff;
  border-radius: 14px;
  padding: 18px 20px;
  margin-bottom: 16px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}

.review-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.review-user {
  font-weight: 600;
}

.review-stars {
  color: #ffb400;
  font-size: 16px;
}

.review-card p {
  margin: 10px 0 12px;
  color: #444;
  line-height: 1.5;
}

/* ========== MOBILE ========== */
@media (max-width: 768px) {
  .listing-content,
  .review-box,
  .reviews-section {
    padding: 25px;
  }

  .listing-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
  }
}
  #map {
    height: 350px;
    width: 100%;
    border-radius: 12px;
    margin-top: 20px;
  }





  /* ========== THINGS TO KNOW ========== */
.things-to-know {
  padding-top: 30px;
  border-top: 1px solid #eee;
}

.section-title {
  font-weight: 600;
  margin-bottom: 25px;
}

.things-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 20px;
}

.things-card {
  background: #fafafa;
  border-radius: 14px;
  padding: 20px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.05);
}

.things-heading {
  font-weight: 600;
  margin-bottom: 10px;
}

.things-text {
  font-size: 14px;
  color: #444;
  line-height: 1.5;
  margin-bottom: 8px;
}

.things-list {
  padding-left: 18px;
  margin-bottom: 8px;
}

.things-list li {
  font-size: 14px;
  color: #444;
  margin-bottom: 6px;
}

.things-link {
  font-size: 14px;
  font-weight: 500;
  color: #222;
  text-decoration: underline;
}


/* ===== RESERVE CARD ===== */
.reserve-card {
  max-width: 520px;
  margin: 40px auto;
  background: #fff;
  border-radius: 16px;
  padding: 28px;
  border: 1px solid #e4e4e4;
  box-shadow: 0 18px 40px rgba(0,0,0,0.12);
}

.reserve-price {
  display: flex;
  align-items: center;
  gap: 8px;
}

.price-night {
  font-size: 22px;
  font-weight: 600;
}

.per-night {
  color: #555;
}



.reserve-subtext {
  font-size: 14px;
  color: #666;
  margin: 8px 0 16px;
}

/* DATE BOX */
.reserve-box {
  border: 1px solid #ccc;
  border-radius: 12px;
  overflow: hidden;
}

.date-box,
.guest-box {
  padding: 10px;
}

.border-left {
  border-left: 1px solid #ccc;
}

.reserve-box label {
  font-size: 11px;
  font-weight: 600;
  display: block;
}

.reserve-box input,
.reserve-box select {
  border: none;
  width: 100%;
  font-size: 14px;
  margin-top: 4px;
}

.reserve-btn {
  width: 100%;
  background: linear-gradient(90deg, #ff385c, #e61e4d);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 12px;
  font-weight: 600;
  margin-top: 16px;
}

.reserve-note {
  text-align: center;
  font-size: 13px;
  margin-top: 10px;
  color: #555;
}

/* PRICE BREAKDOWN */
.price-breakdown {
  margin-top: 18px;
}

.price-row {
  display: flex;
  justify-content: space-between;
  font-size: 14px;
  margin-bottom: 8px;
}

.price-row.total {
  font-weight: 600;
}

.cancel-policy {
  font-size: 13px;
  color: #444;
  margin-top: 14px;
}




</style>

<div class="listing-page">
  <div class="listing-card">

    <!-- IMAGE -->
    <div class="listing-image">
      <img src="<%= listing.image.url %>" alt="<%= listing.title %>">
    </div>

    <!-- LISTING DETAILS -->
    <div class="listing-content">
      <h2 class="listing-title"><%= listing.title %></h2>

      <div class="listing-location">
        <%= listing.location %>, <%= listing.country %>
      </div>

      <div class="listing-owner">
        Hosted by <strong><%= listing.owner.username %></strong>
      </div>

      <div class="listing-description">
        <%= listing.description %>
      </div>

      <div class="listing-info">
        
<!-- booking form -->
 <!-- RESERVE CARD -->
<div class="reserve-card">

  <!-- Price Row -->
  <div class="reserve-price">
    <span class="price-night">
      ₹<%= listing.price.toLocaleString("en-IN") %>
    </span>
    <span class="per-night">night</span>
  </div>

  <p class="reserve-subtext">
    This place is usually booked
  </p>

  <!-- DATE + GUEST BOX -->
  <form action="/listings/<%= listing._id %>/book" method="POST">

    <div class="reserve-box">

      <div class="date-box">
        <label>Check-in</label>
        <input type="date" name="checkIn" id="checkIn" required>
      </div>

      <div class="date-box border-left">
        <label>Checkout</label>
        <input type="date" name="checkOut" id="checkOut" required>
      </div>

      <div class="guest-box">
        <label>Guests</label>
        <select name="guests" id="guests">
          <option value="1">1 guest</option>
          <option value="2">2 guests</option>
          <option value="3">3 guests</option>
          <option value="4">4 guests</option>
        </select>
      </div>

    </div>

    <!-- RESERVE BUTTON -->
    
    <button class="reserve-btn" id="reserveBtn" disabled>
      Reserve
    </button>
  </form>

  <p class="reserve-note">
    You won’t be charged yet
  </p>

  <!-- PRICE BREAKDOWN -->
  <div class="price-breakdown">

  <!-- Hidden hook for JS -->
  <input type="hidden" id="pricePerNight" value="<%= listing.price %>">

  <div class="price-row">
      <span>
        ₹<%= listing.price %> ×
        <span id="nights">0</span> nights ×
        <span id="guestCount">1</span> guest(s)
      </span>
      <span>₹<span id="stayTotal">0</span></span>
    </div>

 <div class="price-row">
      <span>Service fee</span>
      <span>₹<span id="serviceFee">350</span></span>
    </div>


  <hr>

  <div class="price-row total">
    <span>Total before taxes</span>
    <span>
      ₹<span id="grandTotal">0</span>

    </span>
  </div>

</div>


  <!-- POLICY -->
  <p class="cancel-policy">
    <strong>Free cancellation for 24 hours.</strong>
    After that, the reservation is non-refundable.
  </p>

</div>



 <% if (bookingSummary) { %>
  <div class="alert alert-success mt-4">
    <h6 class="fw-semibold mb-2">✔ Booking Confirmed</h6>

    <p class="mb-1">
      <strong>Check-in:</strong>
      <%= new Date(bookingSummary.checkIn).toDateString() %>
    </p>

    <p class="mb-1">
      <strong>Check-out:</strong>
      <%= new Date(bookingSummary.checkOut).toDateString() %>
    </p>

    <p class="mb-0">
      <strong>Total price:</strong>
      ₹<%= bookingSummary.totalPrice.toLocaleString("en-IN") %>
    </p>
  </div>
<% } %>

        <% if (currentUser && currentUser._id.equals(listing.owner._id)) { %>
          <div class="actions">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-edit">Edit</a>

            <form action="/listings/<%= listing._id %>?_method=DELETE" method="POST">
              <button class="btn btn-delete">Delete</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>

<!-- MAP SECTION -->
<div class="listing-map">
  <div id="map"></div>
</div>

<script>
  const MAPTILER_KEY = "<%= MAPTILER_KEY %>";

  const listingData = <%-JSON.stringify({
    title: listing.title,
    price: listing.price,
    lng: listing.geometry?.coordinates?.[0],
    lat: listing.geometry?.coordinates?.[1]
  }) %>;
</script>

<script src="/js/map.js"></script>


    <!-- REVIEW FORM -->
    <div class="review-box">
      <h4>Leave a review</h4>

      <form action="/listings/<%= listing._id %>/reviews" method="POST">

        <fieldset class="starability-slot">
          <legend>Rating</legend>

          <% for(let i = 1; i <= 5; i++) { %>
            <input type="radio" id="rate-<%= i %>" name="review[rating]" value="<%= i %>" required>
            <label for="rate-<%= i %>"><%= i %> star</label>
          <% } %>
        </fieldset>

        <div class="mb-3">
          <textarea
            name="review[comment]"
            rows="4"
            class="form-control"
            placeholder="Share your experience..."
            required
          ></textarea>
        </div>

        <button class="btn btn-dark">Submit Review</button>
      </form>
    </div>

    <!-- REVIEWS -->
    <section class="reviews-section">
      <h4 class="reviews-title">Reviews</h4>

      <% listing.reviews.forEach(review => { %>
        <div class="review-card">

          <div class="review-header">
            <div class="review-user">
              <%= review.author ? review.author.username : "Anonymous" %>
            </div>

            <div class="review-stars">
              <% for(let i = 1; i <= 5; i++) { %>
                <%= i <= review.rating ? "★" : "☆" %>
              <% } %>
            </div>
          </div>

          <p><%= review.comment %></p>

          <% if (
            currentUser &&
            review.author &&
            review.author._id.equals(currentUser._id)
          ) { %>
            <form
              action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE"
              method="POST"
            >
              <button class="btn btn-sm btn-dark">Delete</button>
            </form>
          <% } %>

        </div>
      <% }) %>
    </section>
   
<section class="things-to-know mt-5 p-5">
  <h4 class="section-title">Things to know</h4>

  <div class="things-grid">

    
    <div class="things-card">
      <h6 class="things-heading">Cancellation policy</h6>
      <p class="things-text">
        Free cancellation for 24 hours. After that, the reservation is non-refundable.
      </p>
    </div>


    <div class="things-card">
      <h6 class="things-heading">House rules</h6>
      <ul class="things-list">
        <li>Check-in: 12:00 pm – 10:00 pm</li>
        <li>Checkout before 11:00 am</li>
        <li>1 guest maximum</li>
      </ul>
    </div>

    <div class="things-card">
      <h6 class="things-heading">Safety & property</h6>
      <ul class="things-list">
        <li>Carbon monoxide alarm not reported</li>
        <li>Smoke alarm not reported</li>
        <li>Exterior security cameras on property</li>
      </ul>
    </div>

  </div>
</section>

<script src="/js/priceCal.js"></script>


  </div>
</div>
